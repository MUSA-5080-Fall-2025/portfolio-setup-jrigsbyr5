<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-11-03">

<title>Week 9 Notes ‚Äì Joshua Rigsby - MUSA 5080 Portfolio</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-5b4ad623e5705c0698d39aec6f10cf02.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Joshua Rigsby - MUSA 5080 Portfolio</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-weekly-notes" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Weekly Notes</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-weekly-notes">    
        <li>
    <a class="dropdown-item" href="../weekly-notes/week-01-notes.html">
 <span class="dropdown-text">Week 1 Notes</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../weekly-notes/week-02-notes.html">
 <span class="dropdown-text">Week 2 Notes</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../weekly-notes/week-03-notes.html">
 <span class="dropdown-text">Week 3 Notes</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../weekly-notes/week-04-notes.html">
 <span class="dropdown-text">Week 4 Notes</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../weekly-notes/week-05-notes.html">
 <span class="dropdown-text">Week 5 Notes</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../weekly-notes/week-06-notes.html">
 <span class="dropdown-text">Week 6 Notes</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../weekly-notes/week-07-notes.html">
 <span class="dropdown-text">Week 7 Notes</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../weekly-notes/week-09-notes.html">
 <span class="dropdown-text">Week 9 Notes</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../weekly-notes/week-10-notes.html">
 <span class="dropdown-text">Week 10 Notes</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../weekly-notes/week-11-notes.html">
 <span class="dropdown-text">Week 11 Notes</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../weekly-notes/week-12-notes.html">
 <span class="dropdown-text">Week 12 Notes</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-labs" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Labs</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-labs">    
        <li>
    <a class="dropdown-item" href="../labs/lab0/lab0_template.html">
 <span class="dropdown-text">Lab 0</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-assignments" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Assignments</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-assignments">    
        <li>
    <a class="dropdown-item" href="../labs/lab1/assignment1_template.html">
 <span class="dropdown-text">Assignment 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../labs/lab2/Rigsby_Joshua_Assignment2.html">
 <span class="dropdown-text">Assignment 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../labs/lab3_midterm/Midterm_2025_Slides.html">
 <span class="dropdown-text">Midterm Slides</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../labs/lab3_midterm/Midterm_2025_Technical_Appendix.html">
 <span class="dropdown-text">Midterm Technical Appendix</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../labs/lab4/Actual Assignment 4 copy.html">
 <span class="dropdown-text">Assignmnet 4</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#key-concepts-learned" id="toc-key-concepts-learned" class="nav-link active" data-scroll-target="#key-concepts-learned">Key Concepts Learned</a></li>
  <li><a href="#coding-techniques" id="toc-coding-techniques" class="nav-link" data-scroll-target="#coding-techniques">Coding Techniques</a></li>
  <li><a href="#step-1-create-spatial-object" id="toc-step-1-create-spatial-object" class="nav-link" data-scroll-target="#step-1-create-spatial-object">Step 1: Create spatial object</a></li>
  <li><a href="#step-2-define-neighbors-queen-contiguity" id="toc-step-2-define-neighbors-queen-contiguity" class="nav-link" data-scroll-target="#step-2-define-neighbors-queen-contiguity">Step 2: Define neighbors (Queen contiguity)</a></li>
  <li><a href="#step-3-create-spatial-weights-row-standardized" id="toc-step-3-create-spatial-weights-row-standardized" class="nav-link" data-scroll-target="#step-3-create-spatial-weights-row-standardized">Step 3: Create spatial weights (row-standardized)</a></li>
  <li><a href="#step-4-calculate-local-morans-i" id="toc-step-4-calculate-local-morans-i" class="nav-link" data-scroll-target="#step-4-calculate-local-morans-i">Step 4: Calculate Local Moran‚Äôs I</a></li>
  <li><a href="#step-5-extract-components" id="toc-step-5-extract-components" class="nav-link" data-scroll-target="#step-5-extract-components">Step 5: Extract components</a></li>
  <li><a href="#identifying-high-high-clusters-hotspots" id="toc-identifying-high-high-clusters-hotspots" class="nav-link" data-scroll-target="#identifying-high-high-clusters-hotspots">Identifying High-High Clusters (Hotspots)</a></li>
  <li><a href="#standardize-the-variable-for-quadrant-classification" id="toc-standardize-the-variable-for-quadrant-classification" class="nav-link" data-scroll-target="#standardize-the-variable-for-quadrant-classification">Standardize the variable for quadrant classification</a>
  <ul class="collapse">
  <li><a href="#calculate-spatial-lag-weighted-mean-of-neighbors" id="toc-calculate-spatial-lag-weighted-mean-of-neighbors" class="nav-link" data-scroll-target="#calculate-spatial-lag-weighted-mean-of-neighbors">Calculate spatial lag (weighted mean of neighbors)</a></li>
  <li><a href="#identify-high-high-clusters" id="toc-identify-high-high-clusters" class="nav-link" data-scroll-target="#identify-high-high-clusters">Identify High-High clusters</a></li>
  <li><a href="#criteria" id="toc-criteria" class="nav-link" data-scroll-target="#criteria">Criteria:</a></li>
  <li><a href="#count-hotspots" id="toc-count-hotspots" class="nav-link" data-scroll-target="#count-hotspots">Count hotspots</a></li>
  <li><a href="#distribution-of-crime-counts" id="toc-distribution-of-crime-counts" class="nav-link" data-scroll-target="#distribution-of-crime-counts">Distribution of Crime Counts</a></li>
  <li><a href="#typical-pattern-for-crime-data" id="toc-typical-pattern-for-crime-data" class="nav-link" data-scroll-target="#typical-pattern-for-crime-data">Typical pattern for crime data</a></li>
  <li><a href="#interpreting-poisson-coefficients" id="toc-interpreting-poisson-coefficients" class="nav-link" data-scroll-target="#interpreting-poisson-coefficients">Interpreting Poisson Coefficients</a></li>
  <li><a href="#poisson-regression-in-r" id="toc-poisson-regression-in-r" class="nav-link" data-scroll-target="#poisson-regression-in-r">Poisson Regression in R</a></li>
  <li><a href="#fit-poisson-model" id="toc-fit-poisson-model" class="nav-link" data-scroll-target="#fit-poisson-model">Fit Poisson model</a></li>
  <li><a href="#view-results" id="toc-view-results" class="nav-link" data-scroll-target="#view-results">View results</a></li>
  <li><a href="#exponentiate-coefficients-for-interpretation" id="toc-exponentiate-coefficients-for-interpretation" class="nav-link" data-scroll-target="#exponentiate-coefficients-for-interpretation">Exponentiate coefficients for interpretation</a></li>
  <li><a href="#example-output" id="toc-example-output" class="nav-link" data-scroll-target="#example-output">Example output:</a></li>
  <li><a href="#interpretation" id="toc-interpretation" class="nav-link" data-scroll-target="#interpretation">Interpretation:</a></li>
  <li><a href="#checking-overdispersion-in-r" id="toc-checking-overdispersion-in-r" class="nav-link" data-scroll-target="#checking-overdispersion-in-r">Checking Overdispersion in R</a></li>
  <li><a href="#fit-poisson-model-1" id="toc-fit-poisson-model-1" class="nav-link" data-scroll-target="#fit-poisson-model-1">Fit Poisson model</a></li>
  <li><a href="#calculate-dispersion-parameter" id="toc-calculate-dispersion-parameter" class="nav-link" data-scroll-target="#calculate-dispersion-parameter">Calculate dispersion parameter</a></li>
  <li><a href="#rule-of-thumb" id="toc-rule-of-thumb" class="nav-link" data-scroll-target="#rule-of-thumb">Rule of thumb:</a></li>
  <li><a href="#example-output-1" id="toc-example-output-1" class="nav-link" data-scroll-target="#example-output-1">Example output:</a></li>
  <li><a href="#fit-negative-binomial-model" id="toc-fit-negative-binomial-model" class="nav-link" data-scroll-target="#fit-negative-binomial-model">Fit Negative Binomial model</a></li>
  <li><a href="#view-results-1" id="toc-view-results-1" class="nav-link" data-scroll-target="#view-results-1">View results</a></li>
  <li><a href="#compare-to-poisson" id="toc-compare-to-poisson" class="nav-link" data-scroll-target="#compare-to-poisson">Compare to Poisson</a></li>
  <li><a href="#lower-aic-better-fit" id="toc-lower-aic-better-fit" class="nav-link" data-scroll-target="#lower-aic-better-fit">Lower AIC = better fit</a></li>
  <li><a href="#extract-dispersion-parameter-theta" id="toc-extract-dispersion-parameter-theta" class="nav-link" data-scroll-target="#extract-dispersion-parameter-theta">Extract dispersion parameter (theta)</a></li>
  <li><a href="#deviance-residuals" id="toc-deviance-residuals" class="nav-link" data-scroll-target="#deviance-residuals">Deviance residuals</a></li>
  <li><a href="#identify-outliers" id="toc-identify-outliers" class="nav-link" data-scroll-target="#identify-outliers">Identify outliers</a></li>
  <li><a href="#influence" id="toc-influence" class="nav-link" data-scroll-target="#influence">Influence</a></li>
  <li><a href="#step-1-define-cell-size-in-map-units---meters-for-our-projection" id="toc-step-1-define-cell-size-in-map-units---meters-for-our-projection" class="nav-link" data-scroll-target="#step-1-define-cell-size-in-map-units---meters-for-our-projection">Step 1: Define cell size (in map units - meters for our projection)</a></li>
  <li><a href="#step-2-create-grid-over-study-area" id="toc-step-2-create-grid-over-study-area" class="nav-link" data-scroll-target="#step-2-create-grid-over-study-area">Step 2: Create grid over study area</a></li>
  <li><a href="#step-3-clip-to-study-area-remove-cells-outside-boundary" id="toc-step-3-clip-to-study-area-remove-cells-outside-boundary" class="nav-link" data-scroll-target="#step-3-clip-to-study-area-remove-cells-outside-boundary">Step 3: Clip to study area (remove cells outside boundary)</a></li>
  <li><a href="#check-results" id="toc-check-results" class="nav-link" data-scroll-target="#check-results">Check results</a></li>
  <li><a href="#logo-cv-implementation" id="toc-logo-cv-implementation" class="nav-link" data-scroll-target="#logo-cv-implementation">LOGO-CV Implementation</a></li>
  <li><a href="#get-unique-districts" id="toc-get-unique-districts" class="nav-link" data-scroll-target="#get-unique-districts">Get unique districts</a></li>
  <li><a href="#initialize-results" id="toc-initialize-results" class="nav-link" data-scroll-target="#initialize-results">Initialize results</a></li>
  <li><a href="#loop-through-districts" id="toc-loop-through-districts" class="nav-link" data-scroll-target="#loop-through-districts">Loop through districts</a></li>
  <li><a href="#combine-all-predictions" id="toc-combine-all-predictions" class="nav-link" data-scroll-target="#combine-all-predictions">Combine all predictions</a></li>
  <li><a href="#step-1-convert-to-point-pattern-ppp-object" id="toc-step-1-convert-to-point-pattern-ppp-object" class="nav-link" data-scroll-target="#step-1-convert-to-point-pattern-ppp-object">Step 1: Convert to point pattern (ppp) object</a></li>
  <li><a href="#step-2-calculate-kde" id="toc-step-2-calculate-kde" class="nav-link" data-scroll-target="#step-2-calculate-kde">Step 2: Calculate KDE</a></li>
  <li><a href="#step-3-extract-values-to-fishnet-cells" id="toc-step-3-extract-values-to-fishnet-cells" class="nav-link" data-scroll-target="#step-3-extract-values-to-fishnet-cells">Step 3: Extract values to fishnet cells</a></li>
  <li><a href="#standardize-to-0-1-scale-for-comparison" id="toc-standardize-to-0-1-scale-for-comparison" class="nav-link" data-scroll-target="#standardize-to-0-1-scale-for-comparison">Standardize to 0-1 scale for comparison</a></li>
  <li><a href="#questions-challenges" id="toc-questions-challenges" class="nav-link" data-scroll-target="#questions-challenges">Questions &amp; Challenges</a></li>
  <li><a href="#connections-to-policy" id="toc-connections-to-policy" class="nav-link" data-scroll-target="#connections-to-policy">Connections to Policy</a></li>
  <li><a href="#reflection" id="toc-reflection" class="nav-link" data-scroll-target="#reflection">Reflection</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Week 9 Notes</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 3, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="key-concepts-learned" class="level2">
<h2 class="anchored" data-anchor-id="key-concepts-learned">Key Concepts Learned</h2>
<ul>
<li>New Rgression Models (i.e negative binomial)</li>
<li>New Regression Modeling tools (i.e fishnet/kde)</li>
</ul>
</section>
<section id="coding-techniques" class="level2">
<h2 class="anchored" data-anchor-id="coding-techniques">Coding Techniques</h2>
<p>Local Moran‚Äôs I in R: Step by Step library(spdep)</p>
</section>
<section id="step-1-create-spatial-object" class="level2">
<h2 class="anchored" data-anchor-id="step-1-create-spatial-object">Step 1: Create spatial object</h2>
<p>fishnet_sp &lt;- as_Spatial(fishnet)</p>
</section>
<section id="step-2-define-neighbors-queen-contiguity" class="level2">
<h2 class="anchored" data-anchor-id="step-2-define-neighbors-queen-contiguity">Step 2: Define neighbors (Queen contiguity)</h2>
<p>neighbors &lt;- poly2nb(fishnet_sp, queen = TRUE)</p>
</section>
<section id="step-3-create-spatial-weights-row-standardized" class="level2">
<h2 class="anchored" data-anchor-id="step-3-create-spatial-weights-row-standardized">Step 3: Create spatial weights (row-standardized)</h2>
<p>weights &lt;- nb2listw(neighbors, style = ‚ÄúW‚Äù, zero.policy = TRUE)</p>
</section>
<section id="step-4-calculate-local-morans-i" class="level2">
<h2 class="anchored" data-anchor-id="step-4-calculate-local-morans-i">Step 4: Calculate Local Moran‚Äôs I</h2>
<p>local_moran &lt;- localmoran( fishnet$abandoned_cars, # Variable of interest weights, # Spatial weights zero.policy = TRUE # Handle cells with no neighbors )</p>
</section>
<section id="step-5-extract-components" class="level2">
<h2 class="anchored" data-anchor-id="step-5-extract-components">Step 5: Extract components</h2>
<p>fishnet<span class="math inline">\(local_I &lt;- local_moran[, "Ii"]      # Local I statistic
fishnet\)</span>p_value &lt;- local_moran[, ‚ÄúPr(z != E(Ii))‚Äù] # P-value fishnet$z_score &lt;- local_moran[, ‚ÄúZ.Ii‚Äù] # Z-score</p>
</section>
<section id="identifying-high-high-clusters-hotspots" class="level2">
<h2 class="anchored" data-anchor-id="identifying-high-high-clusters-hotspots">Identifying High-High Clusters (Hotspots)</h2>
</section>
<section id="standardize-the-variable-for-quadrant-classification" class="level1">
<h1>Standardize the variable for quadrant classification</h1>
<p>fishnet<span class="math inline">\(standardized_value &lt;- scale(fishnet\)</span>abandoned_cars)</p>
<section id="calculate-spatial-lag-weighted-mean-of-neighbors" class="level2">
<h2 class="anchored" data-anchor-id="calculate-spatial-lag-weighted-mean-of-neighbors">Calculate spatial lag (weighted mean of neighbors)</h2>
<p>fishnet<span class="math inline">\(spatial_lag &lt;- lag.listw(weights, fishnet\)</span>abandoned_cars) fishnet<span class="math inline">\(standardized_lag &lt;- scale(fishnet\)</span>spatial_lag)</p>
</section>
<section id="identify-high-high-clusters" class="level2">
<h2 class="anchored" data-anchor-id="identify-high-high-clusters">Identify High-High clusters</h2>
<p>fishnet$hotspot &lt;- 0 # Default: not a hotspot</p>
</section>
<section id="criteria" class="level2">
<h2 class="anchored" data-anchor-id="criteria">Criteria:</h2>
<ol type="1">
<li>Value above mean (standardized &gt; 0)</li>
<li>Neighbors above mean (spatial lag &gt; 0)</li>
<li>Statistically significant (p &lt; 0.05)</li>
</ol>
<p>fishnet<span class="math inline">\(hotspot[
  fishnet\)</span>standardized_value &gt; 0 &amp; fishnet<span class="math inline">\(standardized_lag &gt; 0 &amp;
  fishnet\)</span>p_value &lt; 0.05 ] &lt;- 1</p>
</section>
<section id="count-hotspots" class="level2">
<h2 class="anchored" data-anchor-id="count-hotspots">Count hotspots</h2>
<p>sum(fishnet$hotspot)</p>
</section>
<section id="distribution-of-crime-counts" class="level2">
<h2 class="anchored" data-anchor-id="distribution-of-crime-counts">Distribution of Crime Counts</h2>
</section>
<section id="typical-pattern-for-crime-data" class="level2">
<h2 class="anchored" data-anchor-id="typical-pattern-for-crime-data">Typical pattern for crime data</h2>
<p>ggplot(fishnet, aes(x = countBurglaries)) + geom_histogram(binwidth = 1, fill = ‚Äú#440154FF‚Äù, color = ‚Äúwhite‚Äù) + labs( title = ‚ÄúDistribution of Burglary Counts‚Äù, subtitle = ‚ÄúMost cells have 0-2 burglaries, few have many‚Äù, x = ‚ÄúBurglaries per Cell‚Äù, y = ‚ÄúNumber of Cells‚Äù ) + theme_minimal()</p>
</section>
<section id="interpreting-poisson-coefficients" class="level2">
<h2 class="anchored" data-anchor-id="interpreting-poisson-coefficients">Interpreting Poisson Coefficients</h2>
<p>On log scale: ùõΩ1 = change in log(expected count) per unit increase in ùëã1 On count scale (exponentiate): exp(ùõΩ1) = multiplicative effect on expected count Examples: ùõΩ exp(ùõΩ) Interpretation 0.14 1.15 15% increase per unit of X -0.22 0.80 20% decrease per unit of X 0.00 1.00 No effect 0.69 2.00 Doubling per unit of X</p>
</section>
<section id="poisson-regression-in-r" class="level2">
<h2 class="anchored" data-anchor-id="poisson-regression-in-r">Poisson Regression in R</h2>
</section>
<section id="fit-poisson-model" class="level2">
<h2 class="anchored" data-anchor-id="fit-poisson-model">Fit Poisson model</h2>
<p>model_poisson &lt;- glm( countBurglaries ~ Abandoned_Cars + Abandoned_Cars.nn + abandoned.isSig.dist, data = fishnet, family = poisson(link = ‚Äúlog‚Äù) )</p>
</section>
<section id="view-results" class="level2">
<h2 class="anchored" data-anchor-id="view-results">View results</h2>
<p>summary(model_poisson)</p>
</section>
<section id="exponentiate-coefficients-for-interpretation" class="level2">
<h2 class="anchored" data-anchor-id="exponentiate-coefficients-for-interpretation">Exponentiate coefficients for interpretation</h2>
<p>exp(coef(model_poisson))</p>
</section>
<section id="example-output" class="level2">
<h2 class="anchored" data-anchor-id="example-output">Example output:</h2>
<pre><code>                    exp(coef)</code></pre>
<p>(Intercept) 0.234 Abandoned_Cars 1.151 Abandoned_Cars.nn 0.998 abandoned.isSig.dist 0.999</p>
</section>
<section id="interpretation" class="level2">
<h2 class="anchored" data-anchor-id="interpretation">Interpretation:</h2>
<ul>
<li>Each additional abandoned car ‚Üí 15.1% increase in expected burglaries</li>
<li>Each meter from nearest abandoned car ‚Üí 0.2% decrease in expected burglaries</li>
</ul>
<p>‚Ä¢ If ‚âà 1: Poisson is fine ‚Ä¢ If &gt; 1: Overdispersion (common!) ‚Ä¢ If &gt; 2-3: Serious overdispersion ‚Üí Use Negative Binomial</p>
</section>
<section id="checking-overdispersion-in-r" class="level2">
<h2 class="anchored" data-anchor-id="checking-overdispersion-in-r">Checking Overdispersion in R</h2>
</section>
<section id="fit-poisson-model-1" class="level2">
<h2 class="anchored" data-anchor-id="fit-poisson-model-1">Fit Poisson model</h2>
<p>model_pois &lt;- glm( countBurglaries ~ Abandoned_Cars + Abandoned_Cars.nn + abandoned.isSig.dist, data = fishnet, family = poisson )</p>
</section>
<section id="calculate-dispersion-parameter" class="level2">
<h2 class="anchored" data-anchor-id="calculate-dispersion-parameter">Calculate dispersion parameter</h2>
<p>dispersion &lt;- sum(residuals(model_pois, type = ‚Äúpearson‚Äù)^2) / model_pois$df.residual</p>
<p>cat(‚ÄúDispersion parameter:‚Äù, round(dispersion, 3), ‚Äú‚Äù)</p>
</section>
<section id="rule-of-thumb" class="level2">
<h2 class="anchored" data-anchor-id="rule-of-thumb">Rule of thumb:</h2>
<p>&lt; 1.5: Poisson OK 1.5 - 3: Mild overdispersion, NegBin recommended &gt; 3: Serious overdispersion, NegBin essential</p>
</section>
<section id="example-output-1" class="level2">
<h2 class="anchored" data-anchor-id="example-output-1">Example output:</h2>
<p>Dispersion parameter: 4.523 Warning: Serious overdispersion detected</p>
<p>Negative Binomial Regression Relaxes the variance = mean assumption Adds dispersion parameter (ùõº): Var(ùëåùëñ)=ùúáùëñ+ùõºùúá2ùëñ</p>
<p>Negative Binomial in R library(MASS)</p>
</section>
<section id="fit-negative-binomial-model" class="level2">
<h2 class="anchored" data-anchor-id="fit-negative-binomial-model">Fit Negative Binomial model</h2>
<p>model_nb &lt;- glm.nb( countBurglaries ~ Abandoned_Cars + Abandoned_Cars.nn + abandoned.isSig.dist, data = fishnet )</p>
</section>
<section id="view-results-1" class="level2">
<h2 class="anchored" data-anchor-id="view-results-1">View results</h2>
<p>summary(model_nb)</p>
</section>
<section id="compare-to-poisson" class="level2">
<h2 class="anchored" data-anchor-id="compare-to-poisson">Compare to Poisson</h2>
<p>AIC(model_pois) # e.g., 8234.5 AIC(model_nb) # e.g., 6721.3</p>
</section>
<section id="lower-aic-better-fit" class="level2">
<h2 class="anchored" data-anchor-id="lower-aic-better-fit">Lower AIC = better fit</h2>
<p>If NegBin AIC much lower ‚Üí use NegBin</p>
</section>
<section id="extract-dispersion-parameter-theta" class="level2">
<h2 class="anchored" data-anchor-id="extract-dispersion-parameter-theta">Extract dispersion parameter (theta)</h2>
<p>model_nb$theta # e.g., 2.47</p>
<p>Interpretation: Significant overdispersion confirmed</p>
</section>
<section id="deviance-residuals" class="level2">
<h2 class="anchored" data-anchor-id="deviance-residuals">Deviance residuals</h2>
<p>plot(model_nb, which = 1) # Residuals vs.&nbsp;Fitted</p>
</section>
<section id="identify-outliers" class="level2">
<h2 class="anchored" data-anchor-id="identify-outliers">Identify outliers</h2>
<p>outliers &lt;- which(abs(residuals(model_nb, type = ‚Äúdeviance‚Äù)) &gt; 3)</p>
</section>
<section id="influence" class="level2">
<h2 class="anchored" data-anchor-id="influence">Influence</h2>
<p>influence &lt;- cooks.distance(model_nb) influential &lt;- which(influence &gt; 4/length(influence))</p>
<p>Creating a Fishnet Grid library(sf)</p>
</section>
<section id="step-1-define-cell-size-in-map-units---meters-for-our-projection" class="level2">
<h2 class="anchored" data-anchor-id="step-1-define-cell-size-in-map-units---meters-for-our-projection">Step 1: Define cell size (in map units - meters for our projection)</h2>
<p>cell_size &lt;- 500 # 500m x 500m cells</p>
</section>
<section id="step-2-create-grid-over-study-area" class="level2">
<h2 class="anchored" data-anchor-id="step-2-create-grid-over-study-area">Step 2: Create grid over study area</h2>
<p>fishnet &lt;- st_make_grid( chicago_boundary, cellsize = cell_size, square = TRUE, what = ‚Äúpolygons‚Äù ) %&gt;% st_sf() %&gt;% mutate(uniqueID = row_number())</p>
</section>
<section id="step-3-clip-to-study-area-remove-cells-outside-boundary" class="level2">
<h2 class="anchored" data-anchor-id="step-3-clip-to-study-area-remove-cells-outside-boundary">Step 3: Clip to study area (remove cells outside boundary)</h2>
<p>fishnet &lt;- fishnet[chicago_boundary, ]</p>
</section>
<section id="check-results" class="level2">
<h2 class="anchored" data-anchor-id="check-results">Check results</h2>
<p>nrow(fishnet) # Number of cells st_area(fishnet[1, ]) # Area of one cell (should be 250,000 m¬≤)</p>
<p>Leave-One-Group-Out Cross-Validation (LOGO-CV) Principle: Hold out entire spatial groups, not individual cells Process: Divide study area into groups (e.g., police districts) Hold out all cells in District 1 Train model on Districts 2-N Predict for District 1 Repeat for each district</p>
</section>
<section id="logo-cv-implementation" class="level2">
<h2 class="anchored" data-anchor-id="logo-cv-implementation">LOGO-CV Implementation</h2>
</section>
<section id="get-unique-districts" class="level2">
<h2 class="anchored" data-anchor-id="get-unique-districts">Get unique districts</h2>
<p>districts &lt;- unique(fishnet$District)</p>
</section>
<section id="initialize-results" class="level2">
<h2 class="anchored" data-anchor-id="initialize-results">Initialize results</h2>
<p>cv_results &lt;- list()</p>
</section>
<section id="loop-through-districts" class="level2">
<h2 class="anchored" data-anchor-id="loop-through-districts">Loop through districts</h2>
<p>for (dist in districts) { # Split data train_data &lt;- fishnet %&gt;% filter(District != dist) test_data &lt;- fishnet %&gt;% filter(District == dist)</p>
<p># Fit model on training data model_cv &lt;- glm.nb( countBurglaries ~ Abandoned_Cars + Abandoned_Cars.nn + abandoned.isSig.dist, data = train_data )</p>
<p># Predict on test data test_data$prediction &lt;- predict(model_cv, test_data, type = ‚Äúresponse‚Äù)</p>
<p># Store results cv_results[[dist]] &lt;- test_data }</p>
</section>
<section id="combine-all-predictions" class="level2">
<h2 class="anchored" data-anchor-id="combine-all-predictions">Combine all predictions</h2>
<p>all_predictions &lt;- bind_rows(cv_results</p>
<p>Calculating KDE in R library(spatstat)</p>
</section>
<section id="step-1-convert-to-point-pattern-ppp-object" class="level2">
<h2 class="anchored" data-anchor-id="step-1-convert-to-point-pattern-ppp-object">Step 1: Convert to point pattern (ppp) object</h2>
<p>burglary_ppp &lt;- as.ppp( X = st_coordinates(burglaries), W = as.owin(st_bbox(chicago_boundary)) )</p>
</section>
<section id="step-2-calculate-kde" class="level2">
<h2 class="anchored" data-anchor-id="step-2-calculate-kde">Step 2: Calculate KDE</h2>
<p>kde_surface &lt;- density.ppp( burglary_ppp, sigma = 1000, # Bandwidth in meters edge = TRUE # Edge correction )</p>
</section>
<section id="step-3-extract-values-to-fishnet-cells" class="level2">
<h2 class="anchored" data-anchor-id="step-3-extract-values-to-fishnet-cells">Step 3: Extract values to fishnet cells</h2>
<p>fishnet$kde_risk &lt;- raster::extract( raster(kde_surface), st_centroid(fishnet) )</p>
</section>
<section id="standardize-to-0-1-scale-for-comparison" class="level2">
<h2 class="anchored" data-anchor-id="standardize-to-0-1-scale-for-comparison">Standardize to 0-1 scale for comparison</h2>
<p>fishnet<span class="math inline">\(kde_risk &lt;- (fishnet\)</span>kde_risk - min(fishnet<span class="math inline">\(kde_risk, na.rm=T)) /
                     (max(fishnet\)</span>kde_risk, na.rm=T) - min(fishnet$kde_risk, na.rm=T))</p>
</section>
<section id="questions-challenges" class="level2">
<h2 class="anchored" data-anchor-id="questions-challenges">Questions &amp; Challenges</h2>
<p>It is difficult to get a significantly accurate prediction when working with crime data, or at least accurate enough to seem appropriate for the high stakes of the result.</p>
</section>
<section id="connections-to-policy" class="level2">
<h2 class="anchored" data-anchor-id="connections-to-policy">Connections to Policy</h2>
<p>The implications of analyzing crime data are far reaching, critical though and an awareness of potential bias must be understood and considered when working with this type of data as the effects are severe.</p>
<p>Comparing Poisson vs.&nbsp;Negative Binomial</p>
<p>Aspect Poisson Negative Binomial Variance assumption Var = Mean Var = Œº + Œ±Œº¬≤ Overdispersion Cannot handle Accommodates Standard errors Underestimated if overdispersed Correctly estimated Crime data Rarely appropriate Usually better</p>
<p>Model Diagnostics for Count Models Unlike OLS, we don‚Äôt use residual plots the same way Key diagnostics: 1. Dispersion test (already covered) 2. Deviance residuals: Should be roughly normal 3. Pearson residuals: Check for outliers 4. Cook‚Äôs distance: Influential observations 5. Predicted vs.&nbsp;observed: Visual check</p>
<p>Modeling Workflow 1 Setup &amp; Data Preparation Load burglaries (point data) Load abandoned cars (311 calls) Create fishnet (500m √ó 500m grid) Aggregate burglaries to cells</p>
<p>2 Baseline Comparison Kernel Density Estimation (KDE) Simple spatial smoothing What we need to beat!</p>
<p>3 Feature Engineering Using Abandoned Cars as ‚ÄúDisorder Indicator‚Äù: Count in each cell k-Nearest Neighbors (mean distance to 3 nearest) LISA (Local Moran‚Äôs I - identify hot spots) Distance to hot spots (significant clusters)</p>
<p>4 Count Regression Models Fit Poisson regression Test for overdispersion Fit Negative Binomial (if needed) Interpret coefficients</p>
<p>5 Spatial Cross-Validation Leave-One-Group-Out (LOGO) Train on n-1 districts Test on held-out district Calculate MAE/RMSE</p>
<p>6 Model Comparison Compare to KDE baseline Map predictions vs.&nbsp;actual Analyze errors spatially</p>
</section>
<section id="reflection" class="level2">
<h2 class="anchored" data-anchor-id="reflection">Reflection</h2>
<p>While its certainly helpful, I am not confident enough in these analyses, because it just appears that too much is left to question even when we find significant association between predictors.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "Óßã";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>