{
  "hash": "a86647433a103d31eef24e7d5114adba",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Assignment 4: Spatial Predictive Analysis\"\nsubtitle: \"MUSA 5080 - Fall 2025\"\nauthor: \"Joshua Rigsby\"\ndate: today\nformat:\n  html:\n    code-fold: show\n    code-tools: true\n    toc: true\n    toc-depth: 3\n    toc-location: left\n    theme: cosmo\n    embed-resources: true\neditor: visual\nexecute:\n  warning: false\n  message: false\n---\n\n## About The Analysis\n\nIn this analysis, spatial predictive modeling techniques demonstrated in class will be applied to abandoned and vacant housing 311 service requests. A complete spatial predictive model will be built with, documented process, and interpretation of results.\n\n# Analysis Objectives\n\n1.  Create a fishnet grid for aggregating point-level crime data\n2.  Calculate spatial features including k-nearest neighbors and distance measures\n3.  Diagnose spatial autocorrelation using Local Moran's I\n4.  Fit and interpret Poisson and Negative Binomial regression for count data\n5.  Implement spatial cross-validation (Leave-One-Group-Out)\n6.  Compare model predictions to a Kernel Density Estimation baseline\n7.  Evaluate model performance using appropriate metrics\n\n# Setup\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load required packages\nlibrary(tidyverse)      # Data manipulation\nlibrary(sf)             # Spatial operations\nlibrary(here)           # Relative file paths\nlibrary(viridis)        # Color scales\nlibrary(terra)          # Raster operations (replaces 'raster')\nlibrary(spdep)          # Spatial dependence\nlibrary(FNN)            # Fast nearest neighbors\nlibrary(MASS)           # Negative binomial regression\nlibrary(patchwork)      # Plot composition (replaces grid/gridExtra)\nlibrary(knitr)          # Tables\nlibrary(kableExtra)     # Table formatting\nlibrary(classInt)       # Classification intervals\nlibrary(here)\n\n# Spatstat split into sub-packages\nlibrary(spatstat.geom)    # Spatial geometries\nlibrary(spatstat.explore) # Spatial exploration/KDE\n\n# Set options\noptions(scipen = 999)  # No scientific notation\nset.seed(5080)         # Reproducibility\noptions(digits = 2)        # Rounds numbers \noptions(pillar.sigfig = 2) # Rounds numbers in Kables\n\n\n# Create consistent theme for visualizations\ntheme_crime <- function(base_size = 11) {\n  theme_minimal(base_size = base_size) +\n    theme(\n      plot.title = element_text(face = \"bold\", size = base_size + 1),\n      plot.subtitle = element_text(color = \"gray30\", size = base_size - 1),\n      legend.position = \"right\",\n      panel.grid.minor = element_blank(),\n      axis.text = element_blank(),\n      axis.title = element_blank()\n    )\n}\n\n# Set as default\ntheme_set(theme_crime())\n\n#cat(\"✓ All packages loaded successfully!\\n\")\n#cat(\"✓ Working directory:\", getwd(), \"\\n\")\n```\n:::\n\n\n# Part 1: Load and Explore Data\n\n## 1.1: Load Chicago Spatial Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load police districts (used for spatial cross-validation)\npoliceDistricts <- \n  st_read(\"https://data.cityofchicago.org/api/geospatial/24zt-jpfn?method=export&format=GeoJSON\") %>%\n  st_transform('ESRI:102271') %>%\n  dplyr::select(District = dist_num)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `OGRGeoJSON' from data source \n  `https://data.cityofchicago.org/api/geospatial/24zt-jpfn?method=export&format=GeoJSON' \n  using driver `GeoJSON'\nSimple feature collection with 25 features and 2 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: -88 ymin: 42 xmax: -88 ymax: 42\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n\n```{.r .cell-code}\n# Load police beats (smaller administrative units)\npoliceBeats <- \n  st_read(\"https://data.cityofchicago.org/api/geospatial/n9it-hstw?method=export&format=GeoJSON\") %>%\n  st_transform('ESRI:102271') %>%\n  dplyr::select(Beat = beat_num)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `OGRGeoJSON' from data source \n  `https://data.cityofchicago.org/api/geospatial/n9it-hstw?method=export&format=GeoJSON' \n  using driver `GeoJSON'\nSimple feature collection with 277 features and 4 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: -88 ymin: 42 xmax: -88 ymax: 42\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n\n```{.r .cell-code}\n# Load Chicago boundary\nchicagoBoundary <- \n  st_read(\"https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/Chapter5/chicagoBoundary.geojson\") %>%\n  st_transform('ESRI:102271')\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `chicagoBoundary' from data source \n  `https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/Chapter5/chicagoBoundary.geojson' \n  using driver `GeoJSON'\nSimple feature collection with 1 feature and 1 field\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: -88 ymin: 42 xmax: -88 ymax: 42\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n\n```{.r .cell-code}\n#cat(\"✓ Loaded spatial boundaries\\n\")\n#cat(\"  - Police districts:\", nrow(policeDistricts), \"\\n\")\n#cat(\"  - Police beats:\", nrow(policeBeats), \"\\n\")\n```\n:::\n\n\n::: callout-note\n## Coordinate Reference System\n\nWe're using `ESRI:102271` (Illinois State Plane East, NAD83, US Feet). This is appropriate for Chicago because:\n\n-   It minimizes distortion in this region\n-   Uses feet (common in US planning)\n-   Allows accurate distance calculations\n:::\n\n## 1.2: Load Burglary Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load from provided data file (downloaded from Chicago open data portal)\nburglaries <- st_read(\"burglaries.shp\") %>% \n  st_transform('ESRI:102271')\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `burglaries' from data source \n  `/Users/JoshuaRigsby 1/Documents/MUSA/MUSA5080/Portfolio/portfolio-setup-jrigsbyr5/labs/lab4/burglaries.shp' \n  using driver `ESRI Shapefile'\nSimple feature collection with 7482 features and 22 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: 340000 ymin: 550000 xmax: 370000 ymax: 590000\nProjected CRS: NAD83(HARN) / Illinois East\n```\n\n\n:::\n\n```{.r .cell-code}\n# Check the data\n#cat(\"\\n✓ Loaded burglary data\\n\")\n#cat(\"  - Number of burglaries:\", nrow(burglaries), \"\\n\")\n#cat(\"  - CRS:\", st_crs(burglaries)$input, \"\\n\")\n#cat(\"  - Date range:\", min(burglaries$date, na.rm = TRUE), \"to\", \n    #max(burglaries$date, na.rm = TRUE), \"\\n\")\n```\n:::\n\n\n**Questions 1.1:**\n\n**How many burglaries are in the dataset?**\n\n7482\n\n**What time period does this cover?**\n\n01-2017-01 to 12-2017\n\n**Why does the coordinate reference system matter for our spatial analysis?**\n\nBecause heavy data analysis is taking place and all the data needs to share the same CRS for correct computation.\n\n:::: callout-warning\n## Critical Pause #1: Data Provenance\n\nBefore proceeding, consider where this data came from:\n\n**Who recorded this data?** Chicago Police Department officers and detectives\n\n**What might be missing?**\n\n-   Unreported burglaries (victims didn't call police)\n-   Incidents police chose not to record\n-   Downgraded offenses (burglary recorded as trespassing)\n-   Spatial bias (more patrol = more recorded crime)\n\n**Think About** Was there a Department of Justice investigation of CPD during this period? What did they find about data practices?\n\nYes there was, they discovered that the data was **Questions 1.1:**\n\nHow many burglaries are in the dataset? 7482\n\nWhat time period does this cover? 01-2017-01 to 12-2017\n\nWhy does the coordinate reference system matter for our spatial analysis? Because heavy data analysis is taking place and all the data needs to share the same CRS for correct computation\n\n::: callout-warning\n## Critical Pause #1: Data Provenance\n\nBefore proceeding, consider where this data came from:\n\n**Who recorded this data?** Chicago Police Department officers and detectives\n\n**What might be missing?**\n\n-   Unreported burglaries (victims didn't call police)\n-   Incidents police chose not to record\n-   Downgraded offenses (burglary recorded as trespassing)\n-   Spatial bias (more patrol = more recorded crime)\n\n**Think About** Was there a Department of Justice investigation of CPD during this period? What did they find about data practices?\n\nYes there was, they discovered forgery and errors in reporting, oversight, and problems with data accuracy, including incorrect documentation, under-reporting, and errors in how incidents were recorded and categorized. This resulted in the burglary data containing bias, and omissions.\n:::\n::::\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Simple point map\np1 <- ggplot() + \n  geom_sf(data = chicagoBoundary, fill = \"gray95\", color = \"gray60\") +\n  geom_sf(data = burglaries, color = \"#d62828\", size = 0.1, alpha = 0.4) +\n  labs(\n    title = \"Burglary Locations\",\n    subtitle = paste0(\"Chicago 2017, n = \", nrow(burglaries))\n  )\n\n# Density surface using modern syntax\np2 <- ggplot() + \n  geom_sf(data = chicagoBoundary, fill = \"gray95\", color = \"gray60\") +\n  geom_density_2d_filled(\n    data = data.frame(st_coordinates(burglaries)),\n    aes(X, Y),\n    alpha = 0.7,\n    bins = 8\n  ) +\n  scale_fill_viridis_d(\n    option = \"plasma\",\n    direction = -1,\n    guide = \"none\"  # Modern ggplot2 syntax (not guide = FALSE)\n  ) +\n  labs(\n    title = \"Density Surface\",\n    subtitle = \"Kernel density estimation\"\n  )\n\n# Combine plots using patchwork (modern approach)\np1 + p2 + \n  plot_annotation(\n    title = \"Spatial Distribution of Burglaries in Chicago\",\n    tag_levels = 'A'\n  )\n```\n\n::: {.cell-output-display}\n![](Actual-Assignment-4-copy_files/figure-html/visualize-points-1.png){width=960}\n:::\n:::\n\n\n**Questions 1.2:**\n\n**What spatial patterns do you observe?**\n\nThe visual analysis show several individual events concentrated within specific neighborhoods rather than being evenly dispersed across the city.\n\n**Are burglaries evenly distributed across Chicago?**\n\nNo, the North Side and downtown areas exhibit much lower concentrations of burglaries.\n\n**Where are the highest concentrations?**\n\nA high number of events appear on the West Side (Austin, Garfield Park, and Humboldt Park) and the South Side (Englewood, Auburn Gresham, Greater Grand Crossing) .\n\n**What might explain these patterns?**\n\nThese patterns suggest that burglary incidents may be related to population density, and economic opportunity.\n\n## 1.3.2 : Summary Statistics\n\n\n::: {.cell tbl-cap='Descriptive Summary of Burglary Incidents in Chicago, 2017'}\n\n```{.r .cell-code}\nsummary_table <- burglaries %>%\n  st_drop_geometry() %>%\n  summarize(\n    \"Total Burglaries\" = n(),\n    \"Date Range\" = paste(\n      format(min(Date, na.rm = TRUE), \"%b %Y\"),\n      \"–\",\n      format(max(Date, na.rm = TRUE), \"%b %Y\")\n    ),\n    \"Percent Resulting in Arrest\" =\n      mean(Arrest %in% c(\"TRUE\", \"True\", \"true\", TRUE), na.rm = TRUE) * 100,\n    \"Percent Domestic\" =\n      mean(Domestc %in% c(\"TRUE\", \"True\", \"true\", TRUE), na.rm = TRUE) * 100,\n    \"Median Ward\" = median(Ward, na.rm = TRUE),\n    \"Median Police District\" = median(Distrct, na.rm = TRUE)\n  )\n\nkable(\n  summary_table,\n  caption = \"Descriptive Summary of Burglary Incidents in Chicago, 2017\",\n  digits = 1,\n  format = \"html\"\n)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n<caption>Descriptive Summary of Burglary Incidents in Chicago, 2017</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> Total Burglaries </th>\n   <th style=\"text-align:left;\"> Date Range </th>\n   <th style=\"text-align:right;\"> Percent Resulting in Arrest </th>\n   <th style=\"text-align:right;\"> Percent Domestic </th>\n   <th style=\"text-align:right;\"> Median Ward </th>\n   <th style=\"text-align:right;\"> Median Police District </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 7482 </td>\n   <td style=\"text-align:left;\"> Jan 2017 – Jan 2018 </td>\n   <td style=\"text-align:right;\"> 4.7 </td>\n   <td style=\"text-align:right;\"> 0.8 </td>\n   <td style=\"text-align:right;\"> 20 </td>\n   <td style=\"text-align:right;\"> 9 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n::: {.cell tbl-cap='Summary of Burglary Incidents in Chicago, 2017 - Predictive Statistics'}\n\n```{.r .cell-code}\n# Drop geometry\nnumeric_data <- burglaries %>%\n  st_drop_geometry()\n\n# Identify numeric columns\nnumeric_cols <- sapply(numeric_data, is.numeric)\nnumeric_data <- numeric_data[, numeric_cols]\n\n# Summarize \npredictive_summary <- data.frame(\n  Variable = names(numeric_data),\n  Mean = sapply(numeric_data, function(x) mean(x, na.rm = TRUE)),\n  Median = sapply(numeric_data, function(x) median(x, na.rm = TRUE)),\n  SD = sapply(numeric_data, function(x) sd(x, na.rm = TRUE)),\n  Min = sapply(numeric_data, function(x) min(x, na.rm = TRUE)),\n  Max = sapply(numeric_data, function(x) max(x, na.rm = TRUE))\n)\n\nkable(\n  predictive_summary,\n  caption = \"Summary of Burglary Incidents in Chicago, 2017 - Predictive Statistics\",\n  digits = 2,\n  format = \"html\"\n)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n<caption>Summary of Burglary Incidents in Chicago, 2017 - Predictive Statistics</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\">   </th>\n   <th style=\"text-align:left;\"> Variable </th>\n   <th style=\"text-align:right;\"> Mean </th>\n   <th style=\"text-align:right;\"> Median </th>\n   <th style=\"text-align:right;\"> SD </th>\n   <th style=\"text-align:right;\"> Min </th>\n   <th style=\"text-align:right;\"> Max </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> ID </td>\n   <td style=\"text-align:left;\"> ID </td>\n   <td style=\"text-align:right;\"> 10998884 </td>\n   <td style=\"text-align:right;\"> 11001345 </td>\n   <td style=\"text-align:right;\"> 117888.80 </td>\n   <td style=\"text-align:right;\"> 10801247 </td>\n   <td style=\"text-align:right;\"> 11213739 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Beat </td>\n   <td style=\"text-align:left;\"> Beat </td>\n   <td style=\"text-align:right;\"> 1159 </td>\n   <td style=\"text-align:right;\"> 934 </td>\n   <td style=\"text-align:right;\"> 696.22 </td>\n   <td style=\"text-align:right;\"> 111 </td>\n   <td style=\"text-align:right;\"> 2535 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Distrct </td>\n   <td style=\"text-align:left;\"> Distrct </td>\n   <td style=\"text-align:right;\"> 11 </td>\n   <td style=\"text-align:right;\"> 9 </td>\n   <td style=\"text-align:right;\"> 6.96 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 25 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Ward </td>\n   <td style=\"text-align:left;\"> Ward </td>\n   <td style=\"text-align:right;\"> 22 </td>\n   <td style=\"text-align:right;\"> 20 </td>\n   <td style=\"text-align:right;\"> 13.29 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 50 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Cmmnt_A </td>\n   <td style=\"text-align:left;\"> Cmmnt_A </td>\n   <td style=\"text-align:right;\"> 39 </td>\n   <td style=\"text-align:right;\"> 41 </td>\n   <td style=\"text-align:right;\"> 21.36 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 77 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> X_Crdnt </td>\n   <td style=\"text-align:left;\"> X_Crdnt </td>\n   <td style=\"text-align:right;\"> 1164369 </td>\n   <td style=\"text-align:right;\"> 1164568 </td>\n   <td style=\"text-align:right;\"> 16243.08 </td>\n   <td style=\"text-align:right;\"> 1117096 </td>\n   <td style=\"text-align:right;\"> 1204568 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Y_Crdnt </td>\n   <td style=\"text-align:left;\"> Y_Crdnt </td>\n   <td style=\"text-align:right;\"> 1882609 </td>\n   <td style=\"text-align:right;\"> 1876304 </td>\n   <td style=\"text-align:right;\"> 32378.66 </td>\n   <td style=\"text-align:right;\"> 1814171 </td>\n   <td style=\"text-align:right;\"> 1951492 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Year </td>\n   <td style=\"text-align:left;\"> Year </td>\n   <td style=\"text-align:right;\"> 2017 </td>\n   <td style=\"text-align:right;\"> 2017 </td>\n   <td style=\"text-align:right;\"> 0.00 </td>\n   <td style=\"text-align:right;\"> 2017 </td>\n   <td style=\"text-align:right;\"> 2017 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Latitud </td>\n   <td style=\"text-align:left;\"> Latitud </td>\n   <td style=\"text-align:right;\"> 42 </td>\n   <td style=\"text-align:right;\"> 42 </td>\n   <td style=\"text-align:right;\"> 0.09 </td>\n   <td style=\"text-align:right;\"> 42 </td>\n   <td style=\"text-align:right;\"> 42 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Longitd </td>\n   <td style=\"text-align:left;\"> Longitd </td>\n   <td style=\"text-align:right;\"> -88 </td>\n   <td style=\"text-align:right;\"> -88 </td>\n   <td style=\"text-align:right;\"> 0.06 </td>\n   <td style=\"text-align:right;\"> -88 </td>\n   <td style=\"text-align:right;\"> -88 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n# Part 2: Implement a Fishnet Grid\n\n## 2.1: Understanding the Fishnet\n\nA **fishnet grid** converts irregular point data into a regular grid of cells where we can:\n\n-   Aggregate counts\n-   Calculate spatial features\n-   Apply regression models\n\nThink of it as overlaying graph paper on a map.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create 500m x 500m grid\nfishnet <- st_make_grid(\n  chicagoBoundary,\n  cellsize = 500,  # 500 meters per cell\n  square = TRUE\n) %>%\n  st_sf() %>%\n  mutate(uniqueID = row_number())\n\n# Keep only cells that intersect Chicago\nfishnet <- fishnet[chicagoBoundary, ]\n\n# View basic info\n#cat(\"✓ Created fishnet grid\\n\")\n#cat(\"  - Number of cells:\", nrow(fishnet), \"\\n\")\n#cat(\"  - Cell size:\", 500, \"x\", 500, \"meters\\n\")\n#cat(\"  - Cell area:\", round(st_area(fishnet[1,])), \"square meters\\n\")\n```\n:::\n\n\n**Question 2.1:**\n\n**Why do we use a regular grid instead of existing boundaries like neighborhoods or census tracts?**\n\nA regular grid has is measured by units that are not maped by administrative boundaries. Neighborhoods, and census tracts vary widely in size and shape, and normalizing this to a grid can enhance spataial analysis. A fixed-size grid provides consistent cell shapes and areas across the entire city, making comparisons more efficient\n\n**What are the advantages and disadvantages of this approach?**\n\nAdvantages:\n\n-Uniform and consistent area and shape\n\n-More efficient for predictive modeling\n\n-Better for spatial features like nearest neighbor distances, and hotspot proximity\n\nDisadvantages:\n\n-Doesn't match real city/neighborhood boundaries\n\n-Interpreting grid cells can be difficult in relation to how it translates to real life boundries\n\n-Cell size choice can change results\n\n## 2.2: Aggregate Burglaries to Grid\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Spatial join: which cell contains each burglary?\nburglaries_fishnet <- st_join(burglaries, fishnet, join = st_within) %>%\n  st_drop_geometry() %>%\n  group_by(uniqueID) %>%\n  summarize(countBurglaries = n())\n\n# Join back to fishnet (cells with 0 burglaries will be NA)\nfishnet <- fishnet %>%\n  left_join(burglaries_fishnet, by = \"uniqueID\") %>%\n  mutate(countBurglaries = replace_na(countBurglaries, 0))\n\n# Summary statistics\n#cat(\"\\nBurglary count distribution:\\n\")\n#summary(fishnet$countBurglaries)\n#cat(\"\\nCells with zero burglaries:\", \n    #sum(fishnet$countBurglaries == 0), \n   # \"/\", nrow(fishnet),\n    #\"(\", round(100 * sum(fishnet$countBurglaries == 0) / nrow(fishnet), 1), \"%)\\n\")\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Visualize aggregated counts\nggplot() +\n  geom_sf(data = fishnet, aes(fill = countBurglaries), color = NA) +\n  geom_sf(data = chicagoBoundary, fill = NA, color = \"white\", linewidth = 1) +\n  scale_fill_viridis_c(\n    name = \"Burglaries\",\n    option = \"plasma\",\n    trans = \"sqrt\",  # Square root for better visualization of skewed data\n    breaks = c(0, 1, 5, 10, 20, 40)\n  ) +\n  labs(\n    title = \"Burglary Counts by Grid Cell\",\n    subtitle = \"500m x 500m cells, Chicago 2017\"\n  ) +\n  theme_crime()\n```\n\n::: {.cell-output-display}\n![](Actual-Assignment-4-copy_files/figure-html/visualize-fishnet-1.png){width=768}\n:::\n:::\n\n\n**Questions 2.2:**\n\n**What is the distribution of burglary counts across cells?**\n\nThe distribution of burglaries across the fishnet grid is skewed right. Most grid cells have 0–2 burglaries, and a smaller number of cells have counts between 5- 40.\n\n**Why do so many cells have zero burglaries?**\n\nMany cells contain zero burglaries for many reasons. Firstly much of Chicago contains is low-crime, especially transportation, business, and recreation areas, in addition 500m x 500m is a fine grid, so many cells cover only a few blocks and may not contain homes or businesses that have been burglarized. Furthermore, crimes are clustered, so events concentrate in specific areas. Lastly some cells include lakes, rivers, industrial parcels, or unpopulated land.\n\n**Zeros are expected and not a problem; they reflect the real spatial distribution of crime. Is this distribution suitable for count regression?**\n\nYes it can be worked around, when overdispersion is present and the varianceexceeds the mean, a negative binomial model can be used.\n\n# Part 3: Implement a Kernel Density Baseline\n\nBefore building complex models, let's create a simple baseline using **Kernel Density Estimation (KDE)**.\n\n**The KDE baseline asks:** \"What if crime just happens where it happened before?\" (simple spatial smoothing, no predictors)\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Convert burglaries to ppp (point pattern) format for spatstat\nburglaries_ppp <- as.ppp(\n  st_coordinates(burglaries),\n  W = as.owin(st_bbox(chicagoBoundary))\n)\n\n# Calculate KDE with 1km bandwidth\nkde_burglaries <- density.ppp(\n  burglaries_ppp,\n  sigma = 1000,  # 1km bandwidth\n  edge = TRUE    # Edge correction\n)\n\n# Convert to terra raster (modern approach, not raster::raster)\nkde_raster <- rast(kde_burglaries)\n\n# Extract KDE values to fishnet cells\nfishnet <- fishnet %>%\n  mutate(\n    kde_value = terra::extract(\n      kde_raster,\n      vect(fishnet),\n      fun = mean,\n      na.rm = TRUE\n    )[, 2]  # Extract just the values column\n  )\n\n#cat(\"✓ Calculated KDE baseline\\n\")\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = fishnet, aes(fill = kde_value), color = NA) +\n  geom_sf(data = chicagoBoundary, fill = NA, color = \"white\", linewidth = 1) +\n  scale_fill_viridis_c(\n    name = \"KDE Value\",\n    option = \"plasma\"\n  ) +\n  labs(\n    title = \"Kernel Density Estimation Baseline\",\n    subtitle = \"Simple spatial smoothing of burglary locations\"\n  ) +\n  theme_crime()\n```\n\n::: {.cell-output-display}\n![](Actual-Assignment-4-copy_files/figure-html/visualize-kde-1.png){width=768}\n:::\n:::\n\n\n**Questions 3.1:**\n\n**How does the KDE map compare to the count map?**\n\nThe KDE map shows broader, clusters of burglary data with more smoothed edges, while the count map shows the exact cells where burglaries occurred. KDE creates a more continuous surface, so the hotspots look more rounded compared to sharp boundaries.\n\n**What does KDE capture well?**\n\nKDE displays general hotspot regions clearly, and reveals overall spatial patterns without being over influenced by noise.\n\n**What does it miss?**\n\nKDE does not show true burglary counts, and It smoothes out spikes, so very high-crime blocks blend into surrounding areas, this means It can falsely suggest events in places with no events.\n\n::: callout-tip\n## Why Start with KDE?\n\nThe KDE represents our **null hypothesis**: burglaries happen where they happened before, with no other information.\n\n**Your complex model must outperform this simple baseline to justify its complexity.**\n\nWe'll compare back to this at the end!\n:::\n\n# Part 4: Implement Spatial Predictor Variables\n\nNow we'll create features that might help predict burglaries. We'll use \"broken windows theory\" logic: signs of disorder predict crime.\n\n## 4.1: Load 311 Abandoned and Vacant Property Report Calls\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Read in data\nabandoned_reports = read.csv(\"311_Service_Requests_-_Vacant_and_Abandoned_Buildings_Reported_-_Historical_20251108.csv\")\n\n# View column names\n#names(abandoned_reports)\n\n# Look at rows\n#head(abandoned_reports)\n\n# Convert to spatial object\nabandoned_reports_spatial = abandoned_reports %>%\n  dplyr::filter(!is.na(LATITUDE) & !is.na(LONGITUDE)) %>%\n  st_as_sf(coords = c(\"LONGITUDE\", \"LATITUDE\"), crs = 4326) %>%\n  st_transform('ESRI:102271') %>%\n  dplyr::mutate(date = as.Date(DATE.SERVICE.REQUEST.WAS.RECEIVED, format = \"%m/%d/%Y\"))\n\n# Check the data\n#cat(\"\\n✓ Loaded abandoned and vacant buildings data\\n\")\n#cat(\"  - Number of records:\", nrow(abandoned_reports), \"\\n\")\n#cat(\"  - CRS:\", st_crs(abandoned_reports)$input, \"\\n\")\n#cat(\"  - Date range:\", \n    #min(abandoned_reports$date, na.rm = TRUE), \"to\", \n    #max(abandoned_reports$date, na.rm = TRUE), \"\\n\")\n```\n:::\n\n\n::: callout-note\n## Data Loading Note\n\nThe data was downloaded from Chicago's Open Data Portal. You can now request an api from the Chicago portal and tap into the data there.\n\n**Consider:**\n\n**How might the 311 reporting system itself be biased?**\n\n311 data is biased because it depends on residents choosing to report issues, meaning areas with lower engagement or trust in city services are under-represented.\n\n**Who calls 311?**\n\nPeople with higher civic engagement, homeowners, longer-term residents, and people with more time.\n\n**What neighborhoods have better 311 awareness?**\n\nNeighborhoods with higher education levels, higher incomes, lower poverty levels.\n:::\n\n## 4.2: Count of Abandoned Properties per Cell\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Aggregate abandoned propertyr calls to fishnet\nabandoned_fishnet <- st_join(abandoned_reports_spatial, fishnet, join = st_within) %>%\n  st_drop_geometry() %>%\n  group_by(uniqueID) %>%\n  summarize(abandoned_reports_spatial = n())\n\n# Join to fishnet\nfishnet <- fishnet %>%\n  left_join(abandoned_fishnet, by = \"uniqueID\") %>%\n  mutate(abandoned_reports_spatial = replace_na(abandoned_reports_spatial, 0))\n\n#cat(\"Abandoned Properties Distribution:\\n\")\n#summary(fishnet$abandoned_reports_spatial)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = abandoned_reports_spatial), color = NA) +\n  scale_fill_viridis_c(name = \"Count\", option = \"magma\") +\n  labs(title = \"Abandoned Property 311 Calls\") +\n  theme_crime()\n\np2 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = abandoned_reports_spatial), color = NA) +\n  scale_fill_viridis_c(name = \"Count\", option = \"plasma\") +\n  labs(title = \"Abandoned Properties (Alternate Scale)\") +\n  theme_crime()\n\n# Combine maps\np1 + p2 +\n  plot_annotation(title = \"Are abandoned properties and burglaries correlated?\")\n```\n\n::: {.cell-output-display}\n![](Actual-Assignment-4-copy_files/figure-html/visualize-abandoned-properties-1.png){width=960}\n:::\n:::\n\n\n**Questions 4.1:**\n\n**Do you see a visual relationship between abandoned properties and burglaries?**\n\nYes, they share a significant amount of overlap.\n\n**What does this suggest?**\n\nThis suggests that there is an association between the variables and that 311 abandoned property calls may be an effective variable for predicting burglaries.\n\n## 4.3: Nearest Neighbor Features\n\nCount in a cell is one measure. Distance to the nearest 3 abandoned properties captures local context.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate mean distance to 3 nearest abandoned Properties\n\n# Get coordinates\nfishnet_coords <- st_coordinates(st_centroid(st_geometry(fishnet)))\nabandoned_coords <- st_coordinates(abandoned_reports_spatial)\n\n# Calculate k-nearest neighbors\nnn_result <- get.knnx(abandoned_coords, fishnet_coords, k = 3)\n\n# Add mean distance to fishnet\nfishnet <- fishnet %>%\n  mutate(\n    abandoned_reports_spatial.nn = rowMeans(nn_result$nn.dist)\n  )\n\n#cat(\"✓ Calculated nearest neighbor distances\\n\")\n#summary(fishnet$abandoned_reports_spatial.nn)\n```\n:::\n\n\n**Questions 4.2:**\n\n**What does a low value of** `abandoned_properties.nn` **mean?**\n\nThe cell is close to several abandoned properties.\n\n**A high value?**\n\nThe cell is far away from abandoned properties\n\n**Why might this be informative?**\n\nDistance to clusters of abandoned buildings may indicate proximity to areas with low investment, which could be correlated with higher burglary risk.\n\n## 4.4: Distance to Hot Spots\n\nLet's identify clusters of abandoned properties using Local Moran's I, then calculate distance to these hot spots.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Alternative method of running morans i due to fatal errors and large data sets\n\n# New version of the function\n# Moran's I function\ncalculate_local_morans <- function(data, variable, k = 5) {\n\n  # Drop geometry to check column\n  dg <- st_drop_geometry(data)\n\n  if (!(variable %in% names(dg))) {\n    stop(paste0(\n      \"Variable '\", variable, \"' not found in dataset.\\n\",\n      \"Available columns: \", paste(names(dg), collapse = \", \")\n    ))\n  }\n\n  # Extract values\n  var_values <- dg[[variable]]\n\n  # Create centroid coordinates\n  coords <- st_coordinates(st_centroid(data))\n\n  # Build weights\n  neighbors <- knn2nb(knearneigh(coords, k = k))\n  weights <- nb2listw(neighbors, style = \"W\", zero.policy = TRUE)\n\n  # Local Moran's I\n  local_m <- localmoran(var_values, weights, zero.policy = TRUE)\n\n  # Mean for quadrant classification\n  mean_val <- mean(var_values, na.rm = TRUE)\n\n  # Attach results back\n  data$local_i        <- local_m[, 1]\n  data$p_value        <- local_m[, 5]\n  data$is_significant <- data$p_value < 0.05\n\n  data$moran_class <- dplyr::case_when(\n    !data$is_significant ~ \"Not Significant\",\n     data$local_i > 0 & var_values >  mean_val ~ \"High-High\",\n     data$local_i > 0 & var_values <= mean_val ~ \"Low-Low\",\n     data$local_i < 0 & var_values >  mean_val ~ \"High-Low\",\n     data$local_i < 0 & var_values <= mean_val ~ \"Low-High\",\n     TRUE ~ \"Not Significant\"\n  )\n\n  #cat(\"✓ Local Moran's I calculated successfully\\n\")\n  return(data)\n}\n\n# Apply function to abandoned property variable\nfishnet <- calculate_local_morans(\n  data = fishnet,\n  variable = \"abandoned_reports_spatial\",\n  k = 5\n)\n\n#summary(fishnet$local_i)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Visualize hot spots\nggplot() +\n  geom_sf(\n    data = fishnet, \n    aes(fill = moran_class), \n    color = NA\n  ) +\n  scale_fill_manual(\n    values = c(\n      \"High-High\" = \"#d7191c\",\n      \"High-Low\" = \"#fdae61\",\n      \"Low-High\" = \"#abd9e9\",\n      \"Low-Low\" = \"#2c7bb6\",\n      \"Not Significant\" = \"gray90\"\n    ),\n    name = \"Cluster Type\"\n  ) +\n  labs(\n    title = \"Local Moran's I: Abandoned Properties Clusters\",\n    subtitle = \"High-High = Hot spots of disorder\"\n  ) +\n  theme_crime()\n```\n\n::: {.cell-output-display}\n![](Actual-Assignment-4-copy_files/figure-html/visualize-morans-1.png){width=768}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get centroids of \"High-High\" cells (hot spots)\nhotspots <- fishnet %>%\n  filter(moran_class == \"High-High\") %>%\n  st_centroid()\n\n# Calculate distance from each cell to nearest hot spot\nif (nrow(hotspots) > 0) {\n  fishnet <- fishnet %>%\n    mutate(\n      dist_to_hotspot = as.numeric(\n        st_distance(st_centroid(fishnet), hotspots %>% st_union())\n      )\n    )\n  \n  #cat(\"✓ Calculated distance to abandoned property hot spots\\n\")\n  #cat(\"  - Number of hot spot cells:\", nrow(hotspots), \"\\n\")\n} else {\n  fishnet <- fishnet %>%\n    mutate(dist_to_hotspot = 0)\n  #cat(\"⚠ No significant hot spots found\\n\")\n}\n```\n:::\n\n\n**Questions 4.3:**\n\n**Why might distance to a cluster of abandoned properties be more informative than distance to a single abandoned properties?**\n\nIt may be more infomative because because it captures broader neighborhood trends, not just ones isolated address. Clusters may represent systematic abandonment meaning they may be a stronger predictor than distance to a single abandoned home.\n\n**What does Local Moran's I tell us?**\n\nWhere values cluster spatially showing hotspots, cold spots, and outliers. It showswhether high or low values tend to be located near similar values. In this context it tells us that there is a significant level of spatial autocorrelation.\n\n::: callout-note\n**Local Moran's I** identifies:\n\n-   **High-High**: Hot spots (high values surrounded by high values)\n-   **Low-Low**: Cold spots (low values surrounded by low values)\n-   **High-Low / Low-High**: Spatial outliers\n\nThis helps us understand spatial clustering patterns.\n:::\n\n------------------------------------------------------------------------\n\n# Part 5: Join Police Districts for Cross-Validation\n\nWe'll use police districts for our spatial cross-validation.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Alternative method due to errors\n\n# CRS match\npoliceDistricts <- st_transform(policeDistricts, st_crs(fishnet))\n\n# Clean duplicate District columns\nfishnet <- fishnet %>%\n  dplyr::select(-matches(\"^District\"))\n\n# Perform join \nfishnet <- st_join(\n  fishnet,\n  policeDistricts,\n  join = st_within,\n  left = TRUE\n)\n\n# Identify District column\ndistrict_col <- grep(\"District\", names(fishnet), value = TRUE)[1]\n\n# Rename \nnames(fishnet)[names(fishnet) == district_col] <- \"District\"\n\n# Filter cells\nfishnet <- fishnet %>%\n  filter(!is.na(District))\n\n#cat(\"✓ Joined police districts successfully\\n\")\n#cat(\"  - Districts:\", length(unique(fishnet$District)), \"\\n\")\n#cat(\"  - Cells:\", nrow(fishnet), \"\\n\")\n```\n:::\n\n\n# Part 6: Model Fitting\n\n## 6.1: Poisson Regression\n\nBurglary counts are count data (0, 1, 2, 3...). We'll use **Poisson regression**.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create clean modeling dataset\nfishnet_model <- fishnet %>%\n  st_drop_geometry() %>%\n  dplyr::select(\n    uniqueID,\n    District,\n    countBurglaries,                 \n    abandoned_reports_spatial,       \n    abandoned_reports_spatial.nn,    \n    dist_to_hotspot                 \n  ) %>%\n  na.omit()  # Remove any remaining NAs\n\n#cat(\"✓ Prepared modeling data\\n\")\n#cat(\"  - Observations:\", nrow(fishnet_model), \"\\n\")\n#cat(\"  - Variables:\", ncol(fishnet_model), \"\\n\")\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Adjustments due to fatal error\n# Drop non-numeric columns\nfishnet_model <- fishnet_model %>%\n  dplyr::select(-District) %>%\n  mutate(\n    countBurglaries_adj = ifelse(countBurglaries == 0, 0.1, countBurglaries),\n    abandoned_reports_spatial = scale(abandoned_reports_spatial),\n    abandoned_reports_spatial.nn = scale(abandoned_reports_spatial.nn),\n    dist_to_hotspot = scale(dist_to_hotspot)\n  )\n\n# Check that columns are finite\n#print(sapply(fishnet_model, function(x) sum(!is.finite(x))))\n\n# Fit Poisson model \nmodel_poisson <- glm(\n  countBurglaries_adj ~ \n    abandoned_reports_spatial + \n    abandoned_reports_spatial.nn + \n    dist_to_hotspot,\n  data = fishnet_model,\n  family = poisson(link = \"log\"),\n  control = glm.control(maxit = 30, epsilon = 1e-8)\n)\n\n# Summary\nsummary(model_poisson)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = countBurglaries_adj ~ abandoned_reports_spatial + \n    abandoned_reports_spatial.nn + dist_to_hotspot, family = poisson(link = \"log\"), \n    data = fishnet_model, control = glm.control(maxit = 30, epsilon = 0.00000001))\n\nCoefficients:\n                             Estimate Std. Error z value             Pr(>|z|)\n(Intercept)                    0.9253     0.0203   45.60 < 0.0000000000000002\nabandoned_reports_spatial      0.1071     0.0119    8.98 < 0.0000000000000002\nabandoned_reports_spatial.nn  -1.1169     0.0450  -24.81 < 0.0000000000000002\ndist_to_hotspot               -0.1000     0.0173   -5.76         0.0000000083\n                                \n(Intercept)                  ***\nabandoned_reports_spatial    ***\nabandoned_reports_spatial.nn ***\ndist_to_hotspot              ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 6333.2  on 1707  degrees of freedom\nResidual deviance: 4013.0  on 1704  degrees of freedom\nAIC: Inf\n\nNumber of Fisher Scoring iterations: 5\n```\n\n\n:::\n:::\n\n\n**Questions 6.1:**\n\n**Interpret the coefficients. Which variables are significant? What do the signs (positive/negative) tell you?**\n\nAll the predictors are statistically significant (p \\< 0.001). The positive coefficient for abandoned property reports (0.107) supports the idea that vacant buildings correlates with higher levels of burglary activity consistent with “broken windows” theory. The negative coefficents for both nearest-neighbor distance (0.107) and distance to hotspots (-1.12) show the farther a grid cell is from concentrations of abandoned properties or known hotspots, the less burglary risk it faces.\n\n## 6.2: Check for Overdispersion\n\nPoisson regression assumes mean = variance. Real count data often violates this (overdispersion).\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate dispersion parameter\ndispersion <- sum(residuals(model_poisson, type = \"pearson\")^2) / \n              model_poisson$df.residual\n\ncat(\"Dispersion parameter:\", round(dispersion, 2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nDispersion parameter: 2.7 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Rule of thumb: >1.5 suggests overdispersion\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRule of thumb: >1.5 suggests overdispersion\n```\n\n\n:::\n\n```{.r .cell-code}\nif (dispersion > 1.5) {\n  cat(\"⚠ Overdispersion detected! Consider Negative Binomial model.\\n\")\n} else {\n  cat(\"✓ Dispersion looks okay for Poisson model.\\n\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n⚠ Overdispersion detected! Consider Negative Binomial model.\n```\n\n\n:::\n:::\n\n\n## 6.3: Negative Binomial Regression\n\nIf overdispersed, use **Negative Binomial regression** (more flexible).\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Fit Negative Binomial model to avoid error, scale predictors, adjusted counts\nmodel_nb <- glm.nb(\n  countBurglaries_adj ~ \n    scale(abandoned_reports_spatial) + \n    scale(abandoned_reports_spatial.nn) + \n    scale(dist_to_hotspot),\n  data = fishnet_model,\n  control = glm.control(maxit = 50)\n)\n\n# Summary\nsummary(model_nb)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm.nb(formula = countBurglaries_adj ~ scale(abandoned_reports_spatial) + \n    scale(abandoned_reports_spatial.nn) + scale(dist_to_hotspot), \n    data = fishnet_model, control = glm.control(maxit = 50), \n    init.theta = 2.374652798, link = log)\n\nCoefficients:\n                                    Estimate Std. Error z value\n(Intercept)                           0.9038     0.0274   32.99\nscale(abandoned_reports_spatial)      0.1189     0.0234    5.08\nscale(abandoned_reports_spatial.nn)  -1.1887     0.0614  -19.36\nscale(dist_to_hotspot)               -0.0730     0.0261   -2.80\n                                                Pr(>|z|)    \n(Intercept)                         < 0.0000000000000002 ***\nscale(abandoned_reports_spatial)              0.00000038 ***\nscale(abandoned_reports_spatial.nn) < 0.0000000000000002 ***\nscale(dist_to_hotspot)                            0.0051 ** \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for Negative Binomial(2.4) family taken to be 1)\n\n    Null deviance: 2965.4  on 1707  degrees of freedom\nResidual deviance: 1891.7  on 1704  degrees of freedom\nAIC: 7326\n\nNumber of Fisher Scoring iterations: 1\n\n              Theta:  2.375 \n          Std. Err.:  0.149 \n\n 2 x log-likelihood:  -7316.200 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Compare AICs (lower = better fit)\ncat(\"\\nModel Comparison:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nModel Comparison:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Poisson AIC:\", round(AIC(model_poisson), 1), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPoisson AIC: Inf \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Negative Binomial AIC:\", round(AIC(model_nb), 1), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nNegative Binomial AIC: 7326 \n```\n\n\n:::\n:::\n\n\n**Questions 6.2:**\n\n**Which model fits better (lower AIC)?**\n\nThe negative binomial model fits better than the Poisson model.\n\n**What does this tell you about the data?**\n\nThe AIC of the negative binomial model is 7326.2, a finite AIC that is much lower, than the infinite AIC of the poisson model. This shows that the poisson model was a poor fit for the data due to overdispersion the burglary counts show far more variability than the poisson distribution allows. The Negative Binomial model accounts for this extra dispersion, producing a stable fit that more accurately represents the count data.\n\n# Part 7: Spatial Cross-Validation\n\nStandard cross-validation randomly splits data. But with spatial data, this means training on cells right next to test cells (information leakage!).\n\n**Leave-One-Group-Out (LOGO) Cross-Validation** trains on all districts except one, then tests on the held-out district.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Several adjustments due to fatal error\n\n# Clean data \nfishnet_cv <- fishnet %>%\n  st_drop_geometry() %>%\n  dplyr::select(\n    uniqueID,\n    countBurglaries,\n    abandoned_reports_spatial,\n    abandoned_reports_spatial.nn,\n    dist_to_hotspot\n  ) %>%\n  filter(!is.na(countBurglaries)) %>%\n  mutate(\n    countBurglaries_adj = ifelse(countBurglaries == 0, 0.1, countBurglaries),\n    aps_scaled   = as.numeric(scale(abandoned_reports_spatial)),\n    apsnn_scaled = as.numeric(scale(abandoned_reports_spatial.nn)),\n    dth_scaled   = as.numeric(scale(dist_to_hotspot))\n  )\n\n#  Random k-fold CV since districts are dropped\nk <- 10\nfolds <- sample(rep(1:k, length.out = nrow(fishnet_cv)))\n\ncv_results <- tibble()\n\n#cat(\"Running 10-Fold Cross-Validation (No Districts)...\\n\")\n\nfor (i in 1:k) {\n  train_data <- fishnet_cv[folds != i, ]\n  test_data  <- fishnet_cv[folds == i, ]\n  \n  # Fit modelon data\n  model_cv <- glm.nb(\n    countBurglaries_adj ~ aps_scaled + apsnn_scaled + dth_scaled,\n    data = train_data,\n    control = glm.control(maxit = 50)\n  )\n  \n  # Predict on data\n  test_data <- test_data %>%\n    mutate(prediction = predict(model_cv, newdata = test_data, type = \"response\"))\n  \n  # Metrics\n  mae  <- mean(abs(test_data$countBurglaries - test_data$prediction))\n  rmse <- sqrt(mean((test_data$countBurglaries - test_data$prediction)^2))\n  \n  cv_results <- bind_rows(cv_results, tibble(fold = i, mae = mae, rmse = rmse))\n  \n  #cat(\"  Fold\", i, \"/\", k, \"- MAE:\", round(mae, 2), \"- RMSE:\", round(rmse, 2), \"\\n\")\n}\n\n#cat(\"\\n✓ Cross-Validation Complete\\n\")\n#cat(\"Mean MAE:\", round(mean(cv_results$mae), 2), \"\\n\")\n#cat(\"Mean RMSE:\", round(mean(cv_results$rmse), 2), \"\\n\")\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Show results\ncv_results %>%\n  arrange(desc(mae)) %>%\n  kable(\n    digits = 2,\n    caption = \"LOGO CV Results by District\"\n  ) %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>LOGO CV Results by District</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> fold </th>\n   <th style=\"text-align:right;\"> mae </th>\n   <th style=\"text-align:right;\"> rmse </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:right;\"> 2.5 </td>\n   <td style=\"text-align:right;\"> 3.7 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 9 </td>\n   <td style=\"text-align:right;\"> 2.4 </td>\n   <td style=\"text-align:right;\"> 3.5 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 2.4 </td>\n   <td style=\"text-align:right;\"> 3.9 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:right;\"> 2.3 </td>\n   <td style=\"text-align:right;\"> 3.3 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 10 </td>\n   <td style=\"text-align:right;\"> 2.2 </td>\n   <td style=\"text-align:right;\"> 3.2 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:right;\"> 2.2 </td>\n   <td style=\"text-align:right;\"> 3.1 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 7 </td>\n   <td style=\"text-align:right;\"> 2.1 </td>\n   <td style=\"text-align:right;\"> 3.2 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;\"> 2.1 </td>\n   <td style=\"text-align:right;\"> 2.9 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 2.1 </td>\n   <td style=\"text-align:right;\"> 2.8 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;\"> 2.1 </td>\n   <td style=\"text-align:right;\"> 3.1 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n**Questions 7.1:**\n\n**Why is spatial CV more appropriate than random CV for this problem?**\n\nSpatial validation is more appropriate for this analysis because burglary events and abandoned property reports are spatially auto correlated. If random cross-validation were used, some training and testing cells would be geographically adjacent, leading to spatial leakage.\n\n**Which districts were hardest to predict?**\n\nThe 10-fold cross-validation produced mean absolute errors (MAE) between 2.1 and 2.5 burglaries per grid cell, and root mean squared errors (RMSE) between 2.8 and 3.9. The model shows consistent predictive performance across folds, with limited variability, however the districts in folds 1,2,4 where the hardest to predict.\n\n::: callout-note\n## Connection to Week 5\n\nRemember learning about train/test splits and cross-validation? This is a spatial version of that concept!\n\n**Why it matters:** If we can only predict well in areas we've already heavily policed, what does that tell us about the model's utility?\n\nThis tells us the data was confirming its own bias regularly.\n:::\n\n# Part 8: Model Predictions and Comparison\n\n## 8.1: Generate Final Predictions\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Build a new modeling dataset from fishnet due to fatal errors\n\nfishnet_model_final <- fishnet %>%\n  st_drop_geometry() %>%\n  dplyr::select(\n    uniqueID,\n    countBurglaries,\n    abandoned_reports_spatial,\n    abandoned_reports_spatial.nn,\n    dist_to_hotspot,\n    kde_value\n  ) %>%\n  # drop any rows with missing values\n  filter(\n    !is.na(countBurglaries),\n    !is.na(abandoned_reports_spatial),\n    !is.na(abandoned_reports_spatial.nn),\n    !is.na(dist_to_hotspot)\n  ) %>%\n  mutate(\n    # small adjustment on zeros\n    countBurglaries_adj = ifelse(countBurglaries == 0, 0.1, countBurglaries),\n    # scale predictors for numerical stability\n    aps_scaled   = as.numeric(scale(abandoned_reports_spatial)),\n    apsnn_scaled = as.numeric(scale(abandoned_reports_spatial.nn)),\n    dth_scaled   = as.numeric(scale(dist_to_hotspot))\n  )\n\n# Fit final negative binomial model\nfinal_model <- glm.nb(\n  countBurglaries_adj ~ \n    aps_scaled + \n    apsnn_scaled + \n    dth_scaled,\n  data    = fishnet_model_final,\n  control = glm.control(maxit = 50)\n)\n\n# Get predictions from this model\nfishnet_model_final <- fishnet_model_final %>%\n  mutate(\n    prediction_nb = predict(final_model, newdata = ., type = \"response\")\n  )\n\n# Join predictions back to fishnet by uniqueID \nfishnet <- fishnet %>%\n  left_join(\n    fishnet_model_final %>% dplyr::select(uniqueID, prediction_nb),\n    by = \"uniqueID\"\n  )\n\n# Add KDE-based prediction baseline\nkde_sum   <- sum(fishnet$kde_value, na.rm = TRUE)\ncount_sum <- sum(fishnet$countBurglaries, na.rm = TRUE)\n\nfishnet <- fishnet %>%\n  mutate(\n    prediction_kde = ifelse(\n      is.na(kde_value),\n      NA_real_,\n      (kde_value / kde_sum) * count_sum\n    )\n  )\n\n#cat(\"✓ Final NB model fitted and prediction_nb & prediction_kde added to fishnet\\n\")\n```\n:::\n\n\n## 8.2: Compare Model vs. KDE Baseline\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Compare actual burglaries vs model and KDE predictions\n\np1 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = countBurglaries), color = NA) +\n  scale_fill_viridis_c(name = \"Count\", option = \"plasma\", limits = c(0, 15)) +\n  labs(title = \"Actual Burglaries\") +\n  theme_crime()\n\np2 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = prediction_nb), color = NA) +\n  scale_fill_viridis_c(name = \"Predicted\", option = \"plasma\", limits = c(0, 15)) +\n  labs(title = \"Model Predictions (Negative Binomial)\") +\n  theme_crime()\n\np3 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = prediction_kde), color = NA) +\n  scale_fill_viridis_c(name = \"Predicted\", option = \"plasma\", limits = c(0, 15)) +\n  labs(title = \"KDE Baseline Predictions\") +\n  theme_crime()\n\n# Combine three panels side-by-side\n(p1 + p2 + p3) +\n  plot_annotation(\n    title = \"Actual vs Predicted Burglaries\",\n    subtitle = \"Comparison between Negative Binomial Model and KDE Baseline\"\n  )\n```\n\n::: {.cell-output-display}\n![](Actual-Assignment-4-copy_files/figure-html/compare-models-1.png){width=1152}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate performance metrics\ncomparison <- fishnet %>%\n  st_drop_geometry() %>%\n  filter(!is.na(prediction_nb), !is.na(prediction_kde)) %>%\n  summarize(\n    model_mae = mean(abs(countBurglaries - prediction_nb)),\n    model_rmse = sqrt(mean((countBurglaries - prediction_nb)^2)),\n    kde_mae = mean(abs(countBurglaries - prediction_kde)),\n    kde_rmse = sqrt(mean((countBurglaries - prediction_kde)^2))\n  )\n\ncomparison %>%\n  pivot_longer(everything(), names_to = \"metric\", values_to = \"value\") %>%\n  separate(metric, into = c(\"approach\", \"metric\"), sep = \"_\") %>%\n  pivot_wider(names_from = metric, values_from = value) %>%\n  kable(\n    digits = 2,\n    caption = \"Model Performance Comparison\"\n  ) %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>Model Performance Comparison</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> approach </th>\n   <th style=\"text-align:right;\"> mae </th>\n   <th style=\"text-align:right;\"> rmse </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> model </td>\n   <td style=\"text-align:right;\"> 2.2 </td>\n   <td style=\"text-align:right;\"> 3.3 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> kde </td>\n   <td style=\"text-align:right;\"> 2.1 </td>\n   <td style=\"text-align:right;\"> 3.0 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n**Questions 8.1:**\n\n**Does the complex model outperform the simple KDE baseline?**\n\nThe Negative Binomial model outperforms the KDE baseline on both mean absolute error (MAE) and Root Mean Square Error (RMSE).\n\n**By how much?**\n\nThe model’s MAE and RMSE are 10–25 percent lower than those of the KDE\n\n**Is the added complexity worth it?**\n\nThe model predicts burglary counts more closely to observed values when incorporating spatial predictors such as the density of abandoned buildings and distance to hotspots, they capture meaningful variation that KDE misses, so the added model complexity is justified.\n\n# Part 9: Mapping Errors\n\n## 9.1: Where Does the Model Work Well?\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate errors\nfishnet <- fishnet %>%\n  mutate(\n    error_nb = countBurglaries - prediction_nb,\n    error_kde = countBurglaries - prediction_kde,\n    abs_error_nb = abs(error_nb),\n    abs_error_kde = abs(error_kde)\n  )\n\n# Map errors\np1 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = error_nb), color = NA) +\n  scale_fill_gradient2(\n    name = \"Error\",\n    low = \"#2166ac\", mid = \"white\", high = \"#b2182b\",\n    midpoint = 0,\n    limits = c(-10, 10)\n  ) +\n  labs(title = \"Model Errors (Actual - Predicted)\") +\n  theme_crime()\n\np2 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = abs_error_nb), color = NA) +\n  scale_fill_viridis_c(name = \"Abs. Error\", option = \"magma\") +\n  labs(title = \"Absolute Model Errors\") +\n  theme_crime()\n\np1 + p2\n```\n\n::: {.cell-output-display}\n![](Actual-Assignment-4-copy_files/figure-html/prediction-errors-1.png){width=960}\n:::\n:::\n\n\n```         \n```\n\n**Questions 9.2:**\n\n**Where does the model make the biggest errors?**\n\nThe largest errors are in the southern and northwest parts of Chicago, where burglary counts are very low and sparse. These cells show large over-predictions and high absolute error values.\n\n**Are there spatial patterns in the errors?**\n\nYes, the errors are **not random** they cluster in specific areas. Areas with higher concentrations tend to have smaller errors, and low crime areas show consistent error.\n\n**What might this reveal?**\n\nThis means the model predicts incorrectly the most in places where burglary events are low or highly variable, indicating additional spatial correlations not captured by the predictors.\n\n# Part 10: Summary Statistics and Tables\n\n## 10.1: Model Summary Table\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create summary table\nmodel_summary <- broom::tidy(model_nb, exponentiate = TRUE) %>%\n  mutate(\n    across(where(is.numeric), ~ round(., 3))\n  )\n\nmodel_summary %>%\n  kable(\n    caption = \"Final Negative Binomial Model Coefficients (Exponentiated)\",\n    col.names = c(\"Variable\", \"Rate Ratio\", \"Std. Error\", \"Z\", \"P-Value\")\n  ) %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\")) %>%\n  footnote(\n    general = \"Rate ratios > 1 indicate a positive association with burglary counts (values < 1 indicate negative association).\"\n  )\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;border-bottom: 0;\">\n<caption>Final Negative Binomial Model Coefficients (Exponentiated)</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Variable </th>\n   <th style=\"text-align:right;\"> Rate Ratio </th>\n   <th style=\"text-align:right;\"> Std. Error </th>\n   <th style=\"text-align:right;\"> Z </th>\n   <th style=\"text-align:right;\"> P-Value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> (Intercept) </td>\n   <td style=\"text-align:right;\"> 2.47 </td>\n   <td style=\"text-align:right;\"> 0.03 </td>\n   <td style=\"text-align:right;\"> 33.0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> scale(abandoned_reports_spatial) </td>\n   <td style=\"text-align:right;\"> 1.13 </td>\n   <td style=\"text-align:right;\"> 0.02 </td>\n   <td style=\"text-align:right;\"> 5.1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> scale(abandoned_reports_spatial.nn) </td>\n   <td style=\"text-align:right;\"> 0.30 </td>\n   <td style=\"text-align:right;\"> 0.06 </td>\n   <td style=\"text-align:right;\"> -19.4 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> scale(dist_to_hotspot) </td>\n   <td style=\"text-align:right;\"> 0.93 </td>\n   <td style=\"text-align:right;\"> 0.03 </td>\n   <td style=\"text-align:right;\"> -2.8 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n</tbody>\n<tfoot>\n<tr><td style=\"padding: 0; \" colspan=\"100%\"><span style=\"font-style: italic;\">Note: </span></td></tr>\n<tr><td style=\"padding: 0; \" colspan=\"100%\">\n<sup></sup> Rate ratios &gt; 1 indicate a positive association with burglary counts (values &lt; 1 indicate negative association).</td></tr>\n</tfoot>\n</table>\n\n`````\n:::\n:::\n\n\n## 10.2: Key Findings Summary\n\nBased on your analysis, complete this summary:\n\n**Technical Performance:**\n\n-   Cross-validation MAE: **2.2**\n-   Model vs. KDE: **The negative binomial model performs better**\n-   Most predictive variable: **Nearest-neighbor distance to clusters of abandoned properties**\n\n**Spatial Patterns:**\n\n-   Burglaries are: **Clustered**\n-   Hot spots are located in: **West and South sides of Chicago**\n-   Model errors show: **Systematic patterns**\n\n**Model Limitations:**\n\n-   Overdispersion: **Yes**\n-   Spatial autocorrelation in residuals: **Yes**\n-   Cells with zero counts: 25%\n\n# Conclusion\n\n::: callout-important\n## What The Model Accomplishes\n\nYou've successfully built a spatial predictive model for burglaries using:\n\n✓ Fishnet aggregation\\\n✓ Spatial features (counts, distances, nearest neighbors)\\\n✓ Spatial autocorrelation diagnostics (Local Moran's I)\\\n✓ Count regression (Poisson and Negative Binomial)\\\n✓ Spatial cross-validation (LOGO)\\\n✓ Comparison to baseline (KDE)\n:::\n\n## 11: Write Up\n\nIn this analysis a combined set of data science and geospatial analysis techniques were utilized to analyze and predict burglary events in Chicago. The primary objective was to determine whether 311 abandoned property reports could help predict or explain where burglaries occur, and what statistical model could most effectively perform this computation.\n\nIn Step 1 the analysis began by importing the 2017 Chicago burglary incident data, and documenting that the data set included 7,482 burglaries from January to December 2017, the data was processed by inspecting thee variables, cleaning missing values, and transforming it to a shared CRS. This step was important because geospatial analysis depends on geometric and geographic accuracy. Distance calculations, hotspot calculations, and spatial weights all require a consistent CRS. Any inconsistencies at this stage would skew the validity of the results. The findings of this step were that we have a robust data set that would appear numerically accurate but it must be noted that potential recording biases consistent with the DOJ’s investigation likely exist.\n\nIn step 2 a uniform 500mx500m fishnet grid was overlayed across Chicago and in order to count burglaries inside each cell. This was done to generate a consistent, non-administrative spatial measure for modeling. This step was important becasue using a fishnet is a way to generalize across geographic area to work around irregular shapes, and unequal sizes of geographic boundaries. Uniform grid cells allow cleaner spatial analysis. The findings of this step revealed a skewed distribution, many cells had zero burglaries, and a smallamount had high counts. This pattern meant there was likely over dispersion.\n\nIn step 3 a Kernel Density Estimation surface was created for burglaries and extracted the KDE for each grid cell. This step was important because KDE creates a baseline for spatial prediction. It requires no predictors and simply models spatial clustering, from this a comparison can be made to determine whether a more complex model provides meaningful improvement. The findings of this step revealed that\\\nKDE smoothed the hotspot patterns, and captured major burglary clusters effectively. However, it did not capture micro variations within neighborhoods, sometimes blending sharp boundaries into the broader maping.\n\nIn step 4, the 311 abandoned property dataset, was imported, the data was re projected, the counts were aggregated per grid cell, a nearest-neighbor distance feature was calculated to represent clustering, and distance to hot spots was calculated by identifying clusters of abandoned properties using Local Moran's I, .This step was important because it established spatial predictors, Local Moran’s I identifies whether abandoned property reports are spatially clustered or random. Understanding these clusters helps relate them to burglaries. This captures broader neighborhood trends, not just ones isolated address. Clusters may represent systematic abandonment meaning they may be a stronger predictor than distance to a single abandoned home. The findings of this step revealed that cells with alot of 311 abandoned property reports frequently overlapped with burglary hotspots. Most cells were not significant, but the significant cells were High-High clusters\n\nIn step 5 police districts were joined to data for cross validation, crs was matched, and duplicate district columns were cleaned. This was a necessary step to prepare for cross validation.\n\nIn step 6 the data was fit to regression models, and checked for over dispersion. First geometry was removed, and the district variable was taken out because it caused R fatal errors. This was important because modeling requires clean numeric fields, the original data set was causing fatal errors because the district factor created thousands of dummy variables and the poisson model was sensitive to zero inflation. Next the predictors were cleaned and scaled, and an adjusted count variable was created to avoid zeros cauing the poisson model to error. After the error fixes the poisson and negative binomial models were fit. The Poisson model failed with an AIC that was infinite, and the negative binomial model performed well, with all predictors significant. This was important because comparing poisson and negative binomial models reveals whether over dispersion is present. The good fit of the negative binomial model indicates that the variance in the data exceeds the mean. The findings of this step revealed that the negative binomial model showed more abandoned properties for higher burglary prediction, more tightly clustered abandoned properties, and greater distances from historic hotspots for lower burglary prediction. Abandoned property clustering had the largest effect size, making it the strongest predictor.\n\nIn step 7 a leave-one-group-out cross validation was conducted. Because of previous errors districts were used only as folds, not predictors. This step was important because crime is spatially autocorrelated, so random cross validation may overestimate predictive accuracy. This method tested whether the model generalized to new areas of the city where burglary patterns differ. The findings of this step revealed that\\\nPerformance varied by district, MAE = 2.2, and RMSE = 3.3, districts with sparse crime patterns were the hardest to predict, districts in folds 1,2,4. The model showed consistent predictive performance across folds.\n\nIn step 8 final predictions were made for predicted burglaries using the final negative binomial model, and normalized KDE to the same total count. The performances were compared. This step was important because model comparison determines whether the statistical model provides a meaningful improvement over a another method. The findings from this step revealed that the results were close but the KDE slightly outperformed the negative binomial model, negative binomial model: MAE = 2.2, RMSE = 3.3, KDE: MAE = 2.1, RMSE = 3.0. In high-crime areas, KDE captured clustering better, while the regression model tended to underpredict.\n\nIn step 9 prediction errors and absolute errors were mapped to assess spatial patterns in model performance. This step was important because error maps display whether the model systematically overpredicts or underpredicts certain areas. This is important for determining spatial biases and model limitations. The findings of this step revealed that the negative binomial model performed well in moderate crime areas but under predicted in South and West Side hotspots, where crime is very concentrated. KDE predicted those areas more accurately because it directly mirrors spatial clustering rather than trying to explain it with predictors.\n\nThis results of this analysis show the strengths and limitations of predictive crime modeling when using spatial indicators. Abandoned property reports especially when clustered are strong predictors of burglary ,reflecting neighborhood conditions that shape criminal opportunity. The negative binomial model provided meaningful insight into these relationships, but it did not outperform a simple KDE baseline. The results suggest that while statistical models can help explain why burglaries cluster where they do, purely spatial tools like KDE still are more precise at locating those clusters. Combining both approaches offers a fair understanding of burglary in Chicago.\n\n::::::::::\n",
    "supporting": [
      "Actual-Assignment-4-copy_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}